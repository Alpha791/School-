<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School App — Homework & Announcements</title>
  <meta name="theme-color" content="#0066ff" />
  <style>
    :root{
      --max-width:1100px; --accent:#0066ff; --muted:#6b7280; --card:#fff; --bg:#f3f4f6; --text:#0f172a;
      --bg-dark:#0b1220; --card-dark:#071022; --text-dark:#e6eef8;
      --radius:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:12px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-tap-highlight-color: transparent;
    }
    body.dark{background:var(--bg-dark);color:var(--text-dark)}
    .container{
      width:100%;
      max-width:var(--max-width);
      background:var(--card);
      padding:18px;
      border-radius:var(--radius);
      box-shadow:0 8px 30px rgba(2,6,23,0.06);
      min-height:80vh;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    body.dark .container{background:var(--card-dark);box-shadow:none}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:1.1rem;margin:0}

    /* layout */
    .content{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:980px){ .content{grid-template-columns:1fr} }

    /* cards & small controls */
    .card{background:transparent;padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)}
    body:not(.dark) .card{background:#fff;border-color:#eef2ff}
    body.dark .card{border-color: rgba(255,255,255,0.04) }

    form{margin:0}
    .form-row{margin:8px 0;display:flex;flex-direction:column;gap:6px}
    label.sr{position:absolute;height:1px;width:1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap}

    input,select,textarea,button{
      font-size:15px;padding:12px;border-radius:10px;border:1px solid #e6e7eb;
      background:transparent;outline:none;
    }
    input:focus,textarea:focus,select:focus,button:focus{box-shadow:0 0 0 3px rgba(0,102,255,0.12);border-color:var(--accent)}
    textarea{min-height:110px;resize:vertical}
    button{display:inline-block}
    button.primary{background:var(--accent);color:#fff;border:none;padding:12px 14px;border-radius:10px}
    button.ghost{background:transparent;border:1px solid #e6e7eb;padding:10px 12px;border-radius:10px}
    .muted{color:var(--muted);font-size:0.92rem}
    .error{color:#b91c1c}
    .success{color:#16a34a}

    /* lists */
    .list-item{padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);margin-bottom:10px;background:linear-gradient(180deg,#fff,#fbfdff)}
    body.dark .list-item{background:transparent;border-color:rgba(255,255,255,0.03)}
    .meta{font-size:0.85rem;color:var(--muted);margin-top:8px}

    /* responsive touch targets */
    .big-row{display:flex;gap:8px;flex-wrap:wrap}
    .big-row > *{flex:1;min-width:120px}

    /* small-screen adjustments */
    @media (max-width:480px){
      .container{margin:8px}
      input,select,textarea,button{font-size:16px;padding:14px}
      .list-item{padding:14px}
    }

    /* disable selection for learners if applied */
    .no-select{user-select:none;-webkit-user-select:none}

    .visually-hidden{position:absolute;height:1px;width:1px;overflow:hidden;clip:rect(0 0 0 0)}
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <h1>School App — Homework & Announcements</h1>
      <div class="big-row" style="gap:8px">
        <button id="themeToggle" class="ghost" type="button" aria-pressed="false">Toggle Dark / Light</button>
        <div id="status" class="muted" aria-live="polite" style="align-self:center"></div>
      </div>
    </header>

    <!-- AUTH -->
    <section id="authWrap" class="card" aria-live="polite">
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button id="tabLogin" class="ghost" aria-pressed="true" onclick="showPanel('login')">Login</button>
        <button id="tabRegister" class="ghost" aria-pressed="false" onclick="showPanel('register')">Register</button>
      </div>

      <div id="loginPanel" role="region" aria-labelledby="tabLogin">
        <form id="loginForm" autocomplete="on" novalidate>
          <label class="sr" for="loginEmail">Email</label>
          <input id="loginEmail" type="email" inputmode="email" placeholder="Email" required autocomplete="username"/>

          <label class="sr" for="loginPassword">Password</label>
          <input id="loginPassword" type="password" placeholder="Password" required autocomplete="current-password"/>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="primary" type="submit" id="loginBtn">Login</button>
            <button class="ghost" type="button" id="forgotBtn">Forgot?</button>
          </div>

          <div id="loginError" class="error" role="status" aria-live="polite" style="margin-top:8px"></div>
        </form>
      </div>

      <div id="registerPanel" role="region" aria-labelledby="tabRegister" hidden>
        <form id="registerForm" autocomplete="on" novalidate>
          <label class="sr" for="registerName">Full name</label>
          <input id="registerName" type="text" placeholder="Full name" required autocomplete="name"/>

          <label class="sr" for="registerSchool">School / Institution</label>
          <input id="registerSchool" type="text" placeholder="School or Institution" required autocomplete="organization"/>

          <label class="sr" for="registerEmail">Email</label>
          <input id="registerEmail" type="email" placeholder="Email" required autocomplete="email"/>

          <label class="sr" for="registerPassword">Password</label>
          <input id="registerPassword" type="password" placeholder="Password (min 6)" required autocomplete="new-password"/>

          <label class="sr" for="registerType">Role</label>
          <select id="registerType" required>
            <option value="">Select role</option>
            <option value="teacher">Teacher</option>
            <option value="learner">Learner</option>
          </select>

          <div style="margin-top:10px">
            <button class="primary" type="submit">Create account</button>
          </div>

          <div id="registerError" class="error" role="status" aria-live="polite" style="margin-top:8px"></div>
          <div id="registerSuccess" class="success" role="status" aria-live="polite" style="margin-top:8px"></div>
        </form>
      </div>
    </section>

    <div class="content" id="mainContent" hidden>
      <main>
        <!-- Teacher Controls -->
        <section id="teacherControls" class="card" hidden>
          <h3>Post Announcement</h3>
          <div class="form-row">
            <label class="visually-hidden" for="announcementText">Announcement</label>
            <textarea id="announcementText" placeholder="Announcement text"></textarea>
            <div style="display:flex;gap:8px">
              <button id="postAnnouncement" class="primary">Post Announcement</button>
              <div id="announceMsg" class="muted" style="align-self:center"></div>
            </div>
          </div>

          <hr/>

          <h3>Post Homework</h3>
          <form id="homeworkForm" novalidate>
            <div class="form-row">
              <input id="hwTitle" placeholder="Homework title (e.g. Maths: Fractions)" required />
              <textarea id="hwDescription" placeholder="Homework details, instructions, resources, etc" required></textarea>
              <div class="big-row">
                <input id="hwDue" type="date" />
                <select id="hwGrade">
                  <option value="">All grades</option>
                  <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option>
                  <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option>
                  <option>Grade 7</option><option>Grade 8</option><option>Grade 9</option>
                </select>
              </div>
            </div>
            <div style="margin-top:8px">
              <button class="primary" type="submit">Save Homework (persistent)</button>
              <span id="hwMsg" class="muted" style="margin-left:8px"></span>
            </div>
          </form>

          <hr/>

          <h3>Submitted Answers (Teachers only)</h3>
          <div id="submissionsList"></div>
        </section>

        <!-- Announcements -->
        <section class="card" style="margin-top:12px">
          <h3>Announcements</h3>
          <div id="announcementsList" aria-live="polite"></div>
          <div style="text-align:center;margin-top:8px"><button id="loadMoreAnnouncements" class="ghost">Load more</button></div>
        </section>

        <!-- Homeworks -->
        <section class="card" style="margin-top:12px">
          <h3>Homeworks</h3>
          <div id="homeworkList" aria-live="polite"></div>
          <div style="text-align:center;margin-top:8px"><button id="loadMoreHomeworks" class="ghost">Load more</button></div>
        </section>
      </main>

      <aside>
        <section class="card" id="profileCard" style="text-align:center">
          <div id="userInfo" class="muted">Not signed in</div>
          <div style="margin-top:8px"><button id="logoutBtn" class="ghost" hidden>Logout</button></div>
        </section>

        <section class="card" style="margin-top:12px">
          <strong>Info</strong>
          <p class="muted" style="font-size:0.9rem">Dark/Light mode available. Learners cannot view other students' answers; only teachers can mark submissions.</p>
        </section>
      </aside>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    // ---------- Firebase imports ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      sendEmailVerification,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      setDoc,
      doc,
      serverTimestamp,
      query,
      orderBy,
      limit,
      onSnapshot,
      getDocs,
      startAfter,
      getDoc,
      updateDoc,
      enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // ---------- Config (keep private in production) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD_YydnZKjW8IdApXZKMqDHk6ZiF7Ioh-g",
      authDomain: "school-homework-f3191.firebaseapp.com",
      projectId: "school-homework-f3191",
      storageBucket: "school-homework-f3191.appspot.com",
      messagingSenderId: "104455696211",
      appId: "1:104455696211:web:f12c1823675c45064b3ba6"
    };

    // ---------- Init ----------
    let app, auth, db;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      // enable offline persistence (IndexedDB). If device doesn't support, fail gracefully.
      try {
        enableIndexedDbPersistence(db).catch(() => {
          // If it fails, just continue — app still works online.
        });
      } catch (e) {
        // ignore
      }
      document.getElementById('status').textContent = 'Connected';
    } catch (e) {
      document.getElementById('status').textContent = 'Firebase init error';
      console.error('Firebase init error', e);
      // show auth area so admin can see error
    }

    // ---------- UI refs ----------
    const authWrap = document.getElementById('authWrap');
    const loginPanel = document.getElementById('loginPanel');
    const registerPanel = document.getElementById('registerPanel');
    const mainContent = document.getElementById('mainContent');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const announcementsList = document.getElementById('announcementsList');
    const homeworkList = document.getElementById('homeworkList');
    const submissionsList = document.getElementById('submissionsList');

    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const homeworkForm = document.getElementById('homeworkForm');

    const PAGE_SIZE = 10;
    let annCursor = null, hwCursor = null;
    let currentUser = null, currentRole = null;

    // ---------- helpers ----------
    function showPanel(name){
      if(name === 'login'){
        loginPanel.hidden = false;
        registerPanel.hidden = true;
        tabLogin.setAttribute('aria-pressed','true');
        tabRegister.setAttribute('aria-pressed','false');
      } else {
        loginPanel.hidden = true;
        registerPanel.hidden = false;
        tabLogin.setAttribute('aria-pressed','false');
        tabRegister.setAttribute('aria-pressed','true');
      }
    }

    function safeText(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // keyboard accessibility: allow Enter to toggle theme button (already a button)
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const pressed = document.body.classList.contains('dark');
      themeToggle.setAttribute('aria-pressed', String(pressed));
    });

    // ---------- auth handlers ----------
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('registerName').value.trim();
      const school = document.getElementById('registerSchool').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const pass = document.getElementById('registerPassword').value;
      const role = document.getElementById('registerType').value;
      const errEl = document.getElementById('registerError');
      const okEl = document.getElementById('registerSuccess');
      errEl.textContent = ''; okEl.textContent = '';
      if (!name || !school || !email || !pass || pass.length < 6 || !role) {
        errEl.textContent = 'Please fill all fields and choose a role (password min 6 chars).';
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        // store profile
        await setDoc(doc(db, 'users', cred.user.uid), {
          name, school, email, role, createdAt: serverTimestamp()
        });
        if (role === 'teacher') {
          await sendEmailVerification(cred.user);
          okEl.textContent = 'Account created. Verification email sent — please verify to enable posting.';
        } else {
          okEl.textContent = 'Account created. You can now log in.';
        }
        // clear password field
        document.getElementById('registerPassword').value = '';
      } catch (err) {
        console.error('register error', err);
        errEl.textContent = (err && err.code && err.code === 'auth/email-already-in-use') ? 'Email already in use. Please login.' : (err.message || 'Registration failed.');
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value;
      const errEl = document.getElementById('loginError');
      errEl.textContent = '';
      if (!email || !pass) { errEl.textContent = 'Enter both email and password.'; return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // onAuthStateChanged will update UI
      } catch (err) {
        console.error('login error', err);
        if (err && err.code) {
          switch (err.code) {
            case 'auth/invalid-email': errEl.textContent = 'Invalid email address.'; break;
            case 'auth/user-disabled': errEl.textContent = 'This account was disabled.'; break;
            case 'auth/user-not-found': errEl.textContent = 'No account with that email.'; break;
            case 'auth/wrong-password': errEl.textContent = 'Incorrect password.'; break;
            default: errEl.textContent = err.message || 'Login error.';
          }
        } else {
          errEl.textContent = err.message || 'Login error.';
        }
      }
    });

    // quick forgot password (opens a prompt then sends reset)
    document.getElementById('forgotBtn').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      if (!email) return alert('Type your email first to receive reset link.');
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Password reset email sent. Check your inbox.');
      } catch (err) {
        console.error('reset error', err);
        alert('Could not send reset email: ' + (err.message || err.code || 'unknown'));
      }
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    // ---------- role & UI management ----------
    function applyLearnerClientRestrictions() {
      // prevent context menu on long press / right click
      window.addEventListener('contextmenu', e => e.preventDefault(), { capture: true });
      // block copy/paste/cut globally
      ['copy','cut','paste'].forEach(evt => window.addEventListener(evt, e => e.preventDefault(), { capture: true }));
      // block common dev keys (client side only)
      window.addEventListener('keydown', e => {
        if (e.key === 'F12') e.preventDefault();
        if (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase())) e.preventDefault();
        if (e.ctrlKey && e.key.toLowerCase() === 'u') e.preventDefault();
      }, { capture: true });
      // block selection outside inputs
      document.querySelector('.container').classList.add('no-select');
      document.querySelectorAll('input,textarea,select,button').forEach(el => el.classList.remove('no-select'));
    }
    function removeLearnerClientRestrictions() {
      // easiest safe approach: reload the page listeners removed by reloading since we added anonymous handlers.
      // but to be safer: we won't attempt to remove ephemeral listeners here; reload on role change is cleaner.
    }

    // ---------- posting & submissions ----------
    document.getElementById('postAnnouncement').addEventListener('click', async () => {
      if (currentRole !== 'teacher') return alert('Only teachers can post announcements.');
      if (!currentUser.emailVerified) return alert('Please verify your teacher email before posting.');
      const text = document.getElementById('announcementText').value.trim();
      if (!text) return alert('Type announcement');
      try {
        await addDoc(collection(db, 'announcements'), { text, author: currentUser.email, date: serverTimestamp(), persistent: true });
        document.getElementById('announcementText').value = '';
        document.getElementById('announceMsg').textContent = 'Posted';
        setTimeout(()=>document.getElementById('announceMsg').textContent='', 2500);
      } catch (err) {
        console.error('post announcement error', err);
        alert('Posting failed: ' + (err.message || err.code || 'unknown'));
      }
    });

    homeworkForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (currentRole !== 'teacher') return alert('Only teachers can post homework.');
      if (!currentUser.emailVerified) return alert('Please verify your teacher email before posting.');
      const title = document.getElementById('hwTitle').value.trim();
      const desc = document.getElementById('hwDescription').value.trim();
      const due = document.getElementById('hwDue').value || null;
      const grade = document.getElementById('hwGrade').value || null;
      if (!title || !desc) return document.getElementById('hwMsg').textContent = 'Add title and description.';
      try {
        await addDoc(collection(db, 'homeworks'), { title, desc, due, grade, author: currentUser.email, createdAt: serverTimestamp(), persistent: true });
        document.getElementById('hwMsg').textContent = 'Saved — persistent.';
        homeworkForm.reset();
        setTimeout(()=>document.getElementById('hwMsg').textContent='', 3000);
      } catch (err) {
        console.error('save hw', err);
        document.getElementById('hwMsg').textContent = 'Save failed.';
      }
    });

    async function submitAnswer(homeworkId, homeworkTitle) {
      if (currentRole !== 'learner') return alert('Only learners can submit answers.');
      const txt = document.getElementById('answer_for_' + homeworkId).value.trim();
      if (!txt) return alert('Type your answer');
      try {
        await addDoc(collection(db, 'submissions'), { homeworkId, homeworkTitle, answer: txt, student: currentUser.email, createdAt: serverTimestamp(), marked: false });
        document.getElementById('answer_for_' + homeworkId).value = '';
        alert('Answer submitted — only the teacher can view it.');
      } catch (err) {
        console.error('submit answer', err);
        alert('Submit failed: ' + (err.message || err.code || 'unknown'));
      }
    }

    // ---------- listening & rendering ----------
    let annUnsub = null, hwUnsub = null, subUnsub = null;
    function startListeners() {
      // announcements
      const annQ = query(collection(db, 'announcements'), orderBy('date', 'desc'), limit(PAGE_SIZE));
      annUnsub = onSnapshot(annQ, snap => {
        announcementsList.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data(); d._id = docSnap.id;
          announcementsList.appendChild(renderAnnouncement(d));
        });
        annCursor = snap.docs.length ? snap.docs[snap.docs.length - 1] : null;
      }, err => {
        console.error('ann snapshot', err);
        announcementsList.innerHTML = '<div class="muted">Unable to load announcements.</div>';
      });

      // homeworks
      const hwQ = query(collection(db, 'homeworks'), orderBy('createdAt', 'desc'), limit(PAGE_SIZE));
      hwUnsub = onSnapshot(hwQ, snap => {
        homeworkList.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data(); d._id = docSnap.id;
          homeworkList.appendChild(renderHomework(d));
        });
        hwCursor = snap.docs.length ? snap.docs[snap.docs.length - 1] : null;
      }, err => {
        console.error('hw snapshot', err);
        homeworkList.innerHTML = '<div class="muted">Unable to load homeworks.</div>';
      });

      // submissions only if teacher
      if (currentRole === 'teacher') {
        const subQ = query(collection(db, 'submissions'), orderBy('createdAt','desc'), limit(200));
        subUnsub = onSnapshot(subQ, snap => {
          submissionsList.innerHTML = '';
          snap.forEach(docSnap => {
            const s = docSnap.data(); s._id = docSnap.id;
            submissionsList.appendChild(renderSubmission(s, docSnap.id));
          });
        }, err => {
          console.error('sub snapshot', err);
          submissionsList.innerHTML = '<div class="muted">Unable to load submissions.</div>';
        });
      }
    }

    function stopListeners() {
      if (annUnsub) annUnsub(); if (hwUnsub) hwUnsub(); if (subUnsub) subUnsub();
      annUnsub = hwUnsub = subUnsub = null;
    }

    function renderAnnouncement(d) {
      const el = document.createElement('div'); el.className = 'list-item';
      el.innerHTML = `<div>${safeText(d.text)}</div><div class="meta">${safeText(d.author || '')} ${d.date && d.date.toDate ? ' • ' + safeText(d.date.toDate().toLocaleString()) : ''}${d.persistent ? ' • persistent' : ''}</div>`;
      return el;
    }

    function renderHomework(d) {
      const el = document.createElement('div'); el.className = 'list-item';
      let inner = `<strong>${safeText(d.title)}</strong><div style="margin-top:8px">${safeText(d.desc)}</div><div class="meta">${d.grade ? safeText(d.grade) + ' • ' : ''}${d.due ? 'Due: ' + safeText(d.due) : ''} • ${safeText(d.author||'')}</div>`;
      if (currentRole === 'learner') {
        inner += `<div style="margin-top:8px"><textarea id="answer_for_${d._id}" placeholder="Type your answer" maxlength="6000"></textarea><div style="margin-top:8px"><button class="primary" onclick="submitAnswer('${d._id}', ${JSON.stringify(d.title)})">Submit Answer</button></div></div>`;
      }
      el.innerHTML = inner;
      return el;
    }

    function renderSubmission(s, id) {
      const el = document.createElement('div'); el.className = 'list-item';
      el.innerHTML = `<div><strong>${safeText(s.homeworkTitle || '')}</strong> — <span class="muted">${safeText(s.student || '')}</span></div><div style="margin-top:8px">${safeText(s.answer || '')}</div><div class="meta">${s.createdAt && s.createdAt.toDate ? safeText(s.createdAt.toDate().toLocaleString()) : ''} • Marked: ${s.marked ? 'Yes' : 'No'}</div>`;
      // mark/unmark
      const btnWrap = document.createElement('div'); btnWrap.style.marginTop = '8px';
      const markBtn = document.createElement('button'); markBtn.className = 'ghost';
      markBtn.textContent = s.marked ? 'Unmark' : 'Mark as Reviewed';
      markBtn.addEventListener('click', async () => {
        try {
          await updateDoc(doc(db, 'submissions', id), { marked: !s.marked, markedBy: currentUser.email, markedAt: serverTimestamp() });
        } catch (err) { console.error('mark error', err); alert('Failed to update'); }
      });
      btnWrap.appendChild(markBtn);
      el.appendChild(btnWrap);
      return el;
    }

    // expose submitAnswer to inline onclick
    window.submitAnswer = submitAnswer;

    // ---------- auth state changes ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUser = null; currentRole = null;
        userInfo.textContent = 'Not signed in';
        logoutBtn.hidden = true;
        mainContent.hidden = true;
        authWrap.hidden = false;
        stopListeners();
        // reload to remove client restriction listeners (simple, robust)
        // but avoid forcing reload if user just signed out manually
        return;
      }
      currentUser = user;
      // fetch role from users document
      try {
        const udoc = await getDoc(doc(db, 'users', user.uid));
        const profile = udoc.exists() ? udoc.data() : null;
        currentRole = profile?.role || profile?.userType || 'learner';
        userInfo.innerHTML = `<div><strong>${safeText(user.email)}</strong></div><div class="muted">Role: ${safeText(currentRole)}</div>`;
      } catch (err) {
        console.warn('fetch profile failed', err);
        currentRole = 'learner';
        userInfo.textContent = safeText(user.email || 'User');
      }

      authWrap.hidden = true;
      mainContent.hidden = false;
      logoutBtn.hidden = false;

      // teacher verification checks
      if (currentRole === 'teacher') {
        document.getElementById('teacherControls').hidden = false;
        const canPost = user.emailVerified;
        document.getElementById('postAnnouncement').disabled = !canPost;
        Array.from(document.querySelectorAll('#homeworkForm button[type=submit]')).forEach(b => b.disabled = !canPost);
        if (!canPost) alert('Teacher account requires email verification to post. Please check your inbox.');
      } else {
        document.getElementById('teacherControls').hidden = true;
        applyLearnerClientRestrictions();
      }

      // start real-time listeners
      startListeners();
    });

    // ---------- load more helpers ----------
    document.getElementById('loadMoreAnnouncements').addEventListener('click', async () => {
      if (!annCursor) return;
      try {
        const moreQ = query(collection(db, 'announcements'), orderBy('date','desc'), startAfter(annCursor), limit(PAGE_SIZE));
        const snap = await getDocs(moreQ);
        snap.forEach(docSnap => {
          const d = docSnap.data(); d._id = docSnap.id;
          announcementsList.appendChild(renderAnnouncement(d));
        });
        annCursor = snap.docs.length ? snap.docs[snap.docs.length - 1] : annCursor;
      } catch (err) { console.error(err); }
    });

    document.getElementById('loadMoreHomeworks').addEventListener('click', async () => {
      if (!hwCursor) return;
      try {
        const moreQ = query(collection(db, 'homeworks'), orderBy('createdAt','desc'), startAfter(hwCursor), limit(PAGE_SIZE));
        const snap = await getDocs(moreQ);
        snap.forEach(docSnap => {
          const d = docSnap.data(); d._id = docSnap.id;
          homeworkList.appendChild(renderHomework(d));
        });
        hwCursor = snap.docs.length ? snap.docs[snap.docs.length - 1] : hwCursor;
      } catch (err) { console.error(err); }
    });

    // ---------- initial UI state ----------
    showPanel('login');
    // hide main content until auth
    mainContent.hidden = true;
  </script>
</body>
</html>
