<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>School Project — Teacher Homework & Announcements</title>
  <style>
    :root{
      --max-width:1100px; --accent:#0066ff; --muted:#6b7280; --card:#fff; --bg:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, Roboto, system-ui, Arial, sans-serif;margin:12px;background:var(--bg);color:#0f172a;display:flex;justify-content:center}
    .container{width:100%;max-width:var(--max-width);background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:1.25rem;margin:0}

    /* responsive columns */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:14px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    /* forms */
    form{margin:0}
    .card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2ff}
    .form-row{margin:8px 0}
    input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e7eb;font-size:0.95rem}
    textarea{min-height:100px;resize:vertical}
    .row{display:flex;gap:8px}
    .row .col{flex:1}

    button.primary{background:var(--accent);color:#fff;border:none}
    button.ghost{background:transparent;border:1px solid #e6e7eb}

    /* tabs */
    .tabs{display:flex;gap:8px}
    .tab{flex:1;padding:8px;border-radius:8px;text-align:center;background:#f8fafc;border:1px solid #e6eefc;cursor:pointer;font-weight:600}
    .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

    /* lists */
    .list-item{padding:10px;border-radius:8px;border:1px solid #eef2ff;background:linear-gradient(180deg,#fff,#fbfdff);margin-bottom:10px}
    .meta{font-size:0.85rem;color:var(--muted);margin-top:6px}

    /* tiny helpers */
    .muted{color:var(--muted)}
    .hidden{display:none}

    /* performance: keep layout simple, remove heavy shadows on small screens */
    @media (max-width:480px){.container{padding:12px;border-radius:8px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>School App — Homework & Announcements</h1>
      <div id="debug" style="font-size:0.85rem;color:var(--muted)"></div>
    </header>

    <!-- Auth area -->
    <section id="authWrap" class="card" aria-live="polite">
      <div class="tabs" role="tablist">
        <button class="tab active" id="tabLogin" onclick="showTab('login', this)">Login</button>
        <button class="tab" id="tabRegister" onclick="showTab('register', this)">Register</button>
      </div>

      <div id="loginPanel">
        <form id="loginForm">
          <div class="form-row"><input id="loginEmail" type="email" placeholder="Email" required /></div>
          <div class="form-row"><input id="loginPassword" type="password" placeholder="Password" required /></div>
          <div class="form-row row"><button class="primary" type="submit">Login</button><button type="button" class="ghost" onclick="fillTestCredentials('teacher')">Test Teacher</button></div>
          <div id="loginError" class="muted" style="color:#b91c1c;margin-top:6px"></div>
        </form>
      </div>

      <div id="registerPanel" class="hidden">
        <form id="registerForm">
          <div class="form-row"><input id="registerEmail" type="email" placeholder="Email" required /></div>
          <div class="form-row"><input id="registerPassword" type="password" placeholder="Password (min 6)" required /></div>
          <div class="form-row">
            <select id="registerType" required>
              <option value="">Select role</option>
              <option value="teacher">Teacher</option>
              <option value="learner">Learner</option>
            </select>
          </div>
          <div class="form-row"><button class="primary" type="submit">Create account</button></div>
          <div id="registerError" class="muted" style="color:#b91c1c;margin-top:6px"></div>
        </form>
      </div>
    </section>

    <div class="grid">
      <!-- main column: announcements + homeworks -->
      <main>
        <!-- teacher controls (shown after login if teacher) -->
        <section id="teacherControls" class="card hidden">
          <h3>Post Announcement</h3>
          <div class="form-row"><textarea id="announcementText" placeholder="Announcement text"></textarea></div>
          <div class="form-row"><button id="postAnnouncement" class="primary">Post Announcement</button></div>

          <hr style="margin:12px 0" />

          <h3>Post Homework (Teachers only — persistent)</h3>
          <form id="homeworkForm">
            <div class="form-row"><input id="hwTitle" placeholder="Homework title (e.g. Maths: Fractions)" required /></div>
            <div class="form-row"><textarea id="hwDescription" placeholder="Homework details, instructions, resources, etc" required></textarea></div>
            <div class="row">
              <div class="col"><input id="hwDue" type="date" /></div>
              <div class="col"><select id="hwGrade"><option value="">All grades</option><option>Grade 1</option><option>Grade 2</option><option>Grade 3</option><option>Grade 4</option><option>Grade 5</option><option>Grade 6</option><option>Grade 7</option><option>Grade 8</option><option>Grade 9</option></select></div>
            </div>
            <div style="margin-top:8px"><button class="primary" type="submit">Save Homework (persistent)</button></div>
            <div id="hwMsg" class="muted" style="margin-top:8px"></div>
          </form>
        </section>

        <!-- Announcements list -->
        <section class="card" style="margin-top:12px">
          <h3>Announcements</h3>
          <div id="announcementsList"></div>
          <div style="text-align:center;margin-top:8px"><button id="loadMoreAnnouncements" class="ghost">Load more</button></div>
        </section>

        <!-- Homework list -->
        <section class="card" style="margin-top:12px">
          <h3>Homeworks</h3>
          <div id="homeworkList"></div>
          <div style="text-align:center;margin-top:8px"><button id="loadMoreHomeworks" class="ghost">Load more</button></div>
        </section>
      </main>

      <!-- side column: profile / quick actions -->
      <aside>
        <section class="card" id="profileCard" style="text-align:center">
          <div id="userInfo">Not signed in</div>
          <div style="margin-top:8px"><button id="logoutBtn" class="ghost hidden">Logout</button></div>
        </section>

        <section class="card" style="margin-top:12px">
          <strong>Performance & persistence</strong>
          <p class="muted" style="font-size:0.9rem">Homeworks are saved with <code>persistent: true</code> flag in Firestore. The app does not delete them automatically — ensure your Firestore rules or scheduled functions are not configured to remove documents.</p>
        </section>
      </aside>
    </div>
  </div>

  <script type="module">
    // show simple debug
    document.getElementById('debug').textContent = 'Client ready';

    // firebase modular imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp, query, orderBy, limit, onSnapshot, getDocs, startAfter } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js';

    // config (kept as provided)
    const firebaseConfig = {
      apiKey: "AIzaSyD_YydnZKjW8IdApXZKMqDHk6ZiF7Ioh-g",
      authDomain: "school-homework-f3191.firebaseapp.com",
      projectId: "school-homework-f3191",
      storageBucket: "school-homework-f3191.appspot.com",
      messagingSenderId: "104455696211",
      appId: "1:104455696211:web:f12c1823675c45064b3ba6"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const loginPanel = document.getElementById('loginPanel');
    const registerPanel = document.getElementById('registerPanel');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const teacherControls = document.getElementById('teacherControls');
    const userInfo = document.getElementById('userInfo');
    const logoutBtn = document.getElementById('logoutBtn');

    // lists + pagination cursors
    const announcementsList = document.getElementById('announcementsList');
    const homeworkList = document.getElementById('homeworkList');
    const loadMoreAnnouncements = document.getElementById('loadMoreAnnouncements');
    const loadMoreHomeworks = document.getElementById('loadMoreHomeworks');
    let annCursor = null, hwCursor = null;
    const PAGE_SIZE = 10; // load in pages for performance

    // helper: toggle tabs
    window.showTab = (name, btn)=>{
      tabLogin.classList.remove('active'); tabRegister.classList.remove('active');
      if(btn) btn.classList.add('active');
      if(name==='login'){ loginPanel.classList.remove('hidden'); registerPanel.classList.add('hidden'); }
      else { registerPanel.classList.remove('hidden'); loginPanel.classList.add('hidden'); }
    };

    // quick fill
    window.fillTestCredentials = (role)=>{
      document.getElementById('registerEmail').value = role==='teacher' ? 'teacher@school.com' : 'student@school.com';
      document.getElementById('registerPassword').value = '123456';
      document.getElementById('registerType').value = role==='teacher' ? 'teacher' : 'learner';
    };

    // auth handlers
    document.getElementById('registerForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('registerEmail').value.trim();
      const pass = document.getElementById('registerPassword').value;
      const role = document.getElementById('registerType').value;
      const err = document.getElementById('registerError'); err.textContent='';
      if(!email||!pass||pass.length<6||!role){ err.textContent='Fill all fields correctly'; return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        // save profile with role
        await setDoc(doc(db,'users',cred.user.uid),{email,role,createdAt:serverTimestamp()});
      }catch(x){ console.error(x); err.textContent = x.message || 'Create account failed'; }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPassword').value;
      const err = document.getElementById('loginError'); err.textContent='';
      try{ await signInWithEmailAndPassword(auth,email,pass); }catch(x){ console.error(x); err.textContent = x.message || 'Login failed'; }
    });

    logoutBtn.addEventListener('click', ()=>{ signOut(auth); });

    // show/hide UI after auth
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        // fetch role from users collection (best practice)
        let role = 'learner';
        try{
          const docRef = (await getDocs(query(collection(db,'users')))).docs.find(d=>d.id===user.uid);
          if(docRef) role = (docRef.data().role||docRef.data().userType||'learner');
        }catch(e){ console.warn('Could not read role, defaulting to learner',e); }

        userInfo.innerHTML = `<strong>${escapeHtml(user.email)}</strong><div class='muted'>Role: ${escapeHtml(role)}</div>`;
        logoutBtn.classList.remove('hidden');
        document.getElementById('authWrap').classList.add('hidden');
        if(role==='teacher') teacherControls.classList.remove('hidden'); else teacherControls.classList.add('hidden');

        // show lists
        startListeners();
      } else {
        // signed out
        userInfo.textContent = 'Not signed in';
        logoutBtn.classList.add('hidden');
        document.getElementById('authWrap').classList.remove('hidden');
        teacherControls.classList.add('hidden');
        stopListeners();
        announcementsList.innerHTML=''; homeworkList.innerHTML='';
      }
    });

    // posting announcement
    document.getElementById('postAnnouncement').addEventListener('click', async ()=>{
      const text = document.getElementById('announcementText').value.trim();
      if(!text){ alert('Type announcement'); return; }
      try{ await addDoc(collection(db,'announcements'),{text,author:auth.currentUser?.email||'unknown',date:serverTimestamp(),persistent:true}); document.getElementById('announcementText').value=''; }
      catch(e){ console.error(e); alert('Failed to post'); }
    });

    // posting homework
    document.getElementById('homeworkForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = document.getElementById('hwTitle').value.trim();
      const desc = document.getElementById('hwDescription').value.trim();
      const due = document.getElementById('hwDue').value || null;
      const grade = document.getElementById('hwGrade').value || null;
      const msg = document.getElementById('hwMsg'); msg.textContent='';
      if(!title||!desc){ msg.textContent='Please add title and description'; return; }
      try{
        await addDoc(collection(db,'homeworks'),{title,desc,due,grade,author:auth.currentUser?.email||'unknown',createdAt:serverTimestamp(),persistent:true});
        msg.textContent = 'Saved — persistent.';
        document.getElementById('homeworkForm').reset();
      }catch(e){ console.error(e); msg.textContent = 'Save failed'; }
    });

    // realtime listeners for announcements and homeworks with pagination support
    let annUnsub=null, hwUnsub=null;
    function startListeners(){
      // announcements: load first PAGE_SIZE and listen for realtime updates (efficient if your app is small)
      const annQ = query(collection(db,'announcements'), orderBy('date','desc'), limit(PAGE_SIZE));
      annUnsub = onSnapshot(annQ, snap=>{
        announcementsList.innerHTML = '';
        snap.forEach(doc=>{
          const d = doc.data();
          announcementsList.appendChild(renderAnnouncement(d));
        });
        annCursor = snap.docs.length ? snap.docs[snap.docs.length-1] : null;
      }, err=>{ console.error('Ann snapshot',err); announcementsList.innerHTML = '<div class="muted">Failed to load announcements</div>'; });

      const hwQ = query(collection(db,'homeworks'), orderBy('createdAt','desc'), limit(PAGE_SIZE));
      hwUnsub = onSnapshot(hwQ, snap=>{
        homeworkList.innerHTML = '';
        snap.forEach(doc=> homeworkList.appendChild(renderHomework(doc.data())) );
        hwCursor = snap.docs.length ? snap.docs[snap.docs.length-1] : null;
      }, err=>{ console.error('HW snapshot',err); homeworkList.innerHTML = '<div class="muted">Failed to load homeworks</div>'; });
    }
    function stopListeners(){ if(annUnsub) annUnsub(); if(hwUnsub) hwUnsub(); annUnsub=null; hwUnsub=null; }

    // "Load more" actions (one-time fetch to append older items)
    loadMoreAnnouncements.addEventListener('click', async ()=>{
      if(!annCursor) return; // nothing more
      try{
        const moreQ = query(collection(db,'announcements'), orderBy('date','desc'), startAfter(annCursor), limit(PAGE_SIZE));
        const snap = await getDocs(moreQ);
        snap.forEach(doc=> announcementsList.appendChild(renderAnnouncement(doc.data())));
        annCursor = snap.docs.length ? snap.docs[snap.docs.length-1] : annCursor;
      }catch(e){ console.error(e); }
    });
    loadMoreHomeworks.addEventListener('click', async ()=>{
      if(!hwCursor) return;
      try{
        const moreQ = query(collection(db,'homeworks'), orderBy('createdAt','desc'), startAfter(hwCursor), limit(PAGE_SIZE));
        const snap = await getDocs(moreQ);
        snap.forEach(doc=> homeworkList.appendChild(renderHomework(doc.data())));
        hwCursor = snap.docs.length ? snap.docs[snap.docs.length-1] : hwCursor;
      }catch(e){ console.error(e); }
    });

    // render helpers
    function renderAnnouncement(d){
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div>${escapeHtml(d.text||'')}</div><div class='meta'>${d.author?escapeHtml(d.author)+' — ':''}${d.date && d.date.toDate ? escapeHtml(d.date.toDate().toLocaleString()) : ''}${d.persistent? ' • persistent':''}</div>`;
      return el;
    }
    function renderHomework(d){
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<strong>${escapeHtml(d.title||'')}</strong><div style="margin-top:6px">${escapeHtml(d.desc||'')}</div><div class='meta'>${d.grade?escapeHtml(d.grade)+' • ':''}${d.due? 'Due: '+escapeHtml(d.due) : ''} • ${d.author?escapeHtml(d.author):''}</div>`;
      return el;
    }

    // minimal html escape
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[m]); }
  </script>
</body>
</html>
