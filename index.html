<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduSecure Global School System</title>
  <style>
    :root {
      --primary-color: #1a56db;
      --primary-dark: #1e429f;
      --secondary-color: #6b7280;
      --success-color: #047857;
      --warning-color: #d97706;
      --error-color: #dc2626;
      --bg-color: #f9fafb;
      --card-bg: #ffffff;
      --text-color: #111827;
      --border-color: #e5e7eb;
      --accent-color: #7c3aed;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      padding: 0;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      height: calc(100vh - 120px);
      overflow-y: auto;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      padding: 1.5rem 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      position: relative;
      z-index: 100;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .app-version {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 2rem;
      margin-bottom: 2rem;
      position: relative;
      border: 1px solid var(--border-color);
    }
    
    .auth-container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .tab-buttons {
      display: flex;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      background-color: #f1f5f9;
    }
    
    .tab-button {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .tab-button.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
      background-color: white;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(26, 86, 219, 0.1);
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
    }
    
    button:hover:not(:disabled) {
      background-color: var(--primary-dark);
    }
    
    button:disabled {
      background-color: var(--secondary-color);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    button.secondary {
      background-color: var(--secondary-color);
    }
    
    button.secondary:hover:not(:disabled) {
      background-color: #475569;
    }
    
    button.success {
      background-color: var(--success-color);
    }
    
    button.success:hover:not(:disabled) {
      background-color: #065f46;
    }
    
    button.warning {
      background-color: var(--warning-color);
    }
    
    button.warning:hover:not(:disabled) {
      background-color: #b45309;
    }
    
    .error {
      color: var(--error-color);
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    .success {
      color: var(--success-color);
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    .hidden {
      display: none !important;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .announcement-form, .homework-form {
      margin-bottom: 2rem;
    }
    
    .announcements-list, .homework-list, .submissions-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .announcement-card, .homework-card, .submission-card {
      background-color: white;
      border-left: 4px solid var(--primary-color);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: relative;
    }
    
    .homework-card {
      border-left-color: var(--warning-color);
    }
    
    .submission-card {
      border-left-color: var(--success-color);
    }
    
    .announcement-meta, .homework-meta {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--secondary-color);
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--secondary-color);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .tabs-container {
      display: flex;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .content-tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .content-tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .submission-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    
    .grade-input {
      width: 80px;
      margin-right: 10px;
      padding: 5px;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      width: auto;
      color: var(--secondary-color);
      padding: 0;
    }
    
    .security-warning {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: var(--error-color);
      color: white;
      text-align: center;
      padding: 15px;
      font-weight: bold;
      z-index: 1001;
      animation: slideDown 0.3s ease;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    .student-list {
      margin-top: 1.5rem;
    }
    
    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    
    .student-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-submitted {
      background-color: #d1fae5;
      color: var(--success-color);
    }
    
    .status-pending {
      background-color: #fef3c7;
      color: var(--warning-color);
    }
    
    .teacher-name {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        height: calc(100vh - 100px);
      }
      
      .card {
        padding: 1.5rem;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Security Warning -->
  <div id="securityWarning" class="security-warning hidden">
    ‚ö†Ô∏è Security Violation Detected! Multiple tabs are not allowed during homework submission.
  </div>

  <header>
    <div class="container">
      <div class="header-content">
        <h1>EduSecure Global School System</h1>
        <div class="app-version">v4.0</div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Authentication Section -->
    <div id="authSection">
      <div class="auth-container">
        <div class="card">
          <div class="tab-buttons">
            <button class="tab-button active" id="loginTabBtn">Login</button>
            <button class="tab-button" id="registerTabBtn">Register</button>
          </div>

          <!-- Login Form -->
          <div id="loginTab">
            <form id="loginForm">
              <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="email">
              </div>
              <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
              </div>
              <button type="submit" id="loginSubmitBtn">
                <span class="loading hidden"></span>
                Login to Your Account
              </button>
            </form>
            <div id="loginError" class="error"></div>
          </div>

          <!-- Register Form -->
          <div id="registerTab" class="hidden">
            <form id="registerForm">
              <div class="form-group">
                <label for="registerEmail">Email Address</label>
                <input type="email" id="registerEmail" placeholder="Enter your email" required autocomplete="email">
              </div>
              <div class="form-group">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" placeholder="Create a password (min. 8 characters)" required autocomplete="new-password">
              </div>
              <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" placeholder="Enter your full name" required maxlength="50">
              </div>
              <div class="form-group">
                <label for="userType">Account Type</label>
                <select id="userType" required>
                  <option value="">Select your role</option>
                  <option value="teacher">Teacher</option>
                  <option value="learner">Student</option>
                </select>
              </div>
              <button type="submit" id="registerSubmitBtn">
                <span class="loading hidden"></span>
                Create Account
              </button>
            </form>
            <div id="registerError" class="error"></div>
            <div id="registerSuccess" class="success"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherSection" class="hidden">
      <div class="card">
        <div class="dashboard-header">
          <h2>Teacher Dashboard</h2>
          <div class="user-info">
            <div class="user-avatar" id="teacherAvatar">T</div>
            <div>
              <div id="teacherEmail"></div>
              <div id="teacherName" class="teacher-name"></div>
              <small>Teacher Account</small>
            </div>
            <button class="secondary" onclick="logout()" style="width: auto; margin-left: 15px;">Logout</button>
          </div>
        </div>

        <div class="tabs-container">
          <div class="content-tab active" data-tab="announcements">Announcements</div>
          <div class="content-tab" data-tab="homework">Homework</div>
          <div class="content-tab" data-tab="submissions">Submissions</div>
          <div class="content-tab" data-tab="students">Students</div>
        </div>

        <!-- Announcements Tab -->
        <div id="teacherAnnouncementsTab" class="content-panel">
          <div class="announcement-form">
            <h3>Create New Announcement</h3>
            <div class="form-group">
              <textarea id="announcement" placeholder="Write your announcement here..." rows="4" maxlength="1000"></textarea>
              <small style="color: var(--secondary-color); text-align: right; display: block;">
                <span id="announcementCounter">0</span>/1000 characters
              </small>
            </div>
            <button id="postBtn">Post Announcement</button>
          </div>

          <div>
            <h3>Recent Announcements</h3>
            <div id="teacherMessages" class="announcements-list">
              <div class="empty-state">
                <div class="empty-state-icon">üì¢</div>
                <h3>No Announcements Yet</h3>
                <p>Post your first announcement to get started.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Homework Tab -->
        <div id="teacherHomeworkTab" class="content-panel hidden">
          <div class="homework-form">
            <h3>Create New Homework</h3>
            <div class="form-group">
              <input type="text" id="homeworkTitle" placeholder="Homework Title" required maxlength="100">
            </div>
            <div class="form-group">
              <textarea id="homeworkDescription" placeholder="Homework description and instructions..." rows="6" maxlength="2000"></textarea>
              <small style="color: var(--secondary-color); text-align: right; display: block;">
                <span id="homeworkCounter">0</span>/2000 characters
              </small>
            </div>
            <div class="form-group">
              <label for="homeworkDueDate">Due Date</label>
              <input type="datetime-local" id="homeworkDueDate" required>
            </div>
            <button id="postHomeworkBtn">Assign Homework</button>
          </div>

          <div>
            <h3>Assigned Homework</h3>
            <div id="teacherHomework" class="homework-list">
              <div class="empty-state">
                <div class="empty-state-icon">üìö</div>
                <h3>No Homework Yet</h3>
                <p>Assign your first homework to get started.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Submissions Tab -->
        <div id="teacherSubmissionsTab" class="content-panel hidden">
          <h3>Student Submissions</h3>
          <div id="teacherSubmissions" class="submissions-list">
            <div class="empty-state">
              <div class="empty-state-icon">üìù</div>
              <h3>No Submissions Yet</h3>
              <p>Student submissions will appear here.</p>
            </div>
          </div>
        </div>

        <!-- Students Tab -->
        <div id="teacherStudentsTab" class="content-panel hidden">
          <h3>Student Management</h3>
          <div class="student-list">
            <div id="studentList">
              <div class="empty-state">
                <div class="empty-state-icon">üë®‚Äçüéì</div>
                <h3>No Students Registered</h3>
                <p>Student registrations will appear here.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Dashboard -->
    <div id="learnerSection" class="hidden">
      <div class="card">
        <div class="dashboard-header">
          <h2>Student Dashboard</h2>
          <div class="user-info">
            <div class="user-avatar" id="studentAvatar">S</div>
            <div>
              <div id="studentEmail"></div>
              <div id="studentName" class="teacher-name"></div>
              <small>Student Account</small>
            </div>
            <button class="secondary" onclick="logout()" style="width: auto; margin-left: 15px;">Logout</button>
          </div>
        </div>

        <div class="tabs-container">
          <div class="content-tab active" data-tab="announcements">Announcements</div>
          <div class="content-tab" data-tab="homework">Homework</div>
        </div>

        <!-- Announcements Tab -->
        <div id="studentAnnouncementsTab" class="content-panel">
          <h3>Announcements from Teachers</h3>
          <div id="learnerMessages" class="announcements-list">
            <div class="empty-state">
              <div class="empty-state-icon">üì¢</div>
              <h3>No Announcements Yet</h3>
              <p>Check back later for announcements from your teachers.</p>
            </div>
          </div>
        </div>

        <!-- Homework Tab -->
        <div id="studentHomeworkTab" class="content-panel hidden">
          <h3>Assigned Homework</h3>
          <div id="studentHomework" class="homework-list">
            <div class="empty-state">
              <div class="empty-state-icon">üìö</div>
              <h3>No Homework Yet</h3>
              <p>Check back later for homework assignments.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Homework Submission Modal -->
  <div id="submissionModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Submit Homework</h3>
        <button class="close-modal" onclick="closeSubmissionModal()">&times;</button>
      </div>
      <div class="form-group">
        <label for="submissionContent">Your Submission</label>
        <textarea id="submissionContent" placeholder="Write your homework submission here..." rows="10" maxlength="5000"></textarea>
        <small style="color: var(--secondary-color); text-align: right; display: block;">
          <span id="submissionCounter">0</span>/5000 characters
        </small>
      </div>
      <button id="submitHomeworkBtn" class="success">Submit Homework</button>
    </div>
  </div>

  <script type="module">
    // Security and state management
    let homeworkModalOpen = false;
    let tabBlurCount = 0;
    let securityTimeout = null;
    let currentHomeworkId = null;

    // Initialize security features
    function initializeSecurity() {
      // Disable right-click
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showSecurityWarning('Right-click is disabled');
        return false;
      });
      
      // Disable text selection on non-input elements
      document.addEventListener('selectstart', function(e) {
        if (!e.target.matches('input, textarea, [contenteditable="true"]')) {
          e.preventDefault();
          return false;
        }
      });
      
      // Disable drag and drop
      document.addEventListener('dragstart', function(e) {
        if (!e.target.matches('input, textarea')) {
          e.preventDefault();
          return false;
        }
      });
      
      // Disable developer tools
      document.addEventListener('keydown', function(e) {
        if (
          e.key === 'F12' ||
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
          (e.ctrlKey && e.key === 'U') ||
          (e.metaKey && e.altKey && e.key === 'I')
        ) {
          e.preventDefault();
          showSecurityWarning('Developer tools are disabled');
          return false;
        }
      });
      
      // Monitor tab/window focus
      window.addEventListener('blur', function() {
        if (homeworkModalOpen) {
          tabBlurCount++;
          if (tabBlurCount > 1) {
            showSecurityWarning('Multiple tabs detected during homework submission');
            // Close modal and prevent further submissions
            closeSubmissionModal();
            disableHomeworkSubmission();
          }
        }
      });
      
      window.addEventListener('focus', function() {
        // Reset blur count when returning to the tab
        tabBlurCount = 0;
      });
      
      // Prevent leaving page during submission
      window.addEventListener('beforeunload', function(e) {
        if (homeworkModalOpen) {
          e.preventDefault();
          e.returnValue = 'You have an ongoing homework submission. Are you sure you want to leave?';
          return e.returnValue;
        }
      });
    }
    
    function showSecurityWarning(message) {
      const warning = document.getElementById('securityWarning');
      warning.textContent = `‚ö†Ô∏è ${message}`;
      warning.classList.remove('hidden');
      
      clearTimeout(securityTimeout);
      securityTimeout = setTimeout(() => {
        warning.classList.add('hidden');
      }, 5000);
    }
    
    function disableHomeworkSubmission() {
      const homeworkButtons = document.querySelectorAll('#studentHomework button');
      homeworkButtons.forEach(button => {
        button.disabled = true;
        button.textContent = 'Submission Disabled';
      });
    }

    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      serverTimestamp, 
      orderBy, 
      query,
      doc,
      setDoc,
      updateDoc,
      where,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD_YydnZKjW8IdApXZKMqDHk6ZiF7Ioh-g",
      authDomain: "school-homework-f3191.firebaseapp.com",
      projectId: "school-homework-f3191",
      storageBucket: "school-homework-f3191.appspot.com",
      messagingSenderId: "104455696211",
      appId: "1:104455696211:web:f12c1823675c45064b3ba6"
    };

    try {
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Initialize security
      initializeSecurity();

      // DOM references
      const elements = {
        authSection: document.getElementById("authSection"),
        teacherSection: document.getElementById("teacherSection"),
        learnerSection: document.getElementById("learnerSection"),
        teacherMessages: document.getElementById("teacherMessages"),
        learnerMessages: document.getElementById("learnerMessages"),
        loginError: document.getElementById("loginError"),
        registerError: document.getElementById("registerError"),
        registerSuccess: document.getElementById("registerSuccess"),
        teacherEmail: document.getElementById("teacherEmail"),
        studentEmail: document.getElementById("studentEmail"),
        teacherName: document.getElementById("teacherName"),
        studentName: document.getElementById("studentName"),
        teacherAvatar: document.getElementById("teacherAvatar"),
        studentAvatar: document.getElementById("studentAvatar"),
        teacherHomework: document.getElementById("teacherHomework"),
        studentHomework: document.getElementById("studentHomework"),
        teacherSubmissions: document.getElementById("teacherSubmissions"),
        studentList: document.getElementById("studentList"),
        submissionModal: document.getElementById("submissionModal"),
        submissionContent: document.getElementById("submissionContent"),
        submitHomeworkBtn: document.getElementById("submitHomeworkBtn"),
        loginTabBtn: document.getElementById("loginTabBtn"),
        registerTabBtn: document.getElementById("registerTabBtn"),
        loginSubmitBtn: document.getElementById("loginSubmitBtn"),
        registerSubmitBtn: document.getElementById("registerSubmitBtn"),
        announcement: document.getElementById("announcement"),
        homeworkTitle: document.getElementById("homeworkTitle"),
        homeworkDescription: document.getElementById("homeworkDescription"),
        homeworkDueDate: document.getElementById("homeworkDueDate")
      };

      // Character counters
      function initializeCharacterCounters() {
        // Announcement counter
        elements.announcement.addEventListener('input', function() {
          document.getElementById('announcementCounter').textContent = this.value.length;
        });

        // Homework description counter
        elements.homeworkDescription.addEventListener('input', function() {
          document.getElementById('homeworkCounter').textContent = this.value.length;
        });

        // Submission content counter
        elements.submissionContent.addEventListener('input', function() {
          document.getElementById('submissionCounter').textContent = this.value.length;
        });
      }

      // Tab switching function for auth
      function showAuthTab(tabName) {
        // Update tab buttons
        elements.loginTabBtn.classList.toggle('active', tabName === 'login');
        elements.registerTabBtn.classList.toggle('active', tabName === 'register');
        
        // Show/hide tabs
        document.getElementById('loginTab').classList.toggle('hidden', tabName !== 'login');
        document.getElementById('registerTab').classList.toggle('hidden', tabName !== 'register');
        
        // Clear messages
        elements.loginError.textContent = '';
        elements.registerError.textContent = '';
        elements.registerSuccess.textContent = '';
      }

      // Teacher tab switching
      function showTeacherTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.content-tab').forEach(tab => {
          tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
        });
        
        // Show/hide tabs
        document.querySelectorAll('.content-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        document.getElementById(`teacher${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.remove('hidden');
        
        if (tabName === 'homework') {
          loadHomework('teacher');
        } else if (tabName === 'submissions') {
          loadSubmissions();
        } else if (tabName === 'students') {
          loadStudentList();
        }
      }

      // Student tab switching
      function showStudentTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.content-tab').forEach(tab => {
          tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
        });
        
        // Show/hide tabs
        document.querySelectorAll('.content-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        document.getElementById(`student${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.remove('hidden');
        
        if (tabName === 'homework') {
          loadHomework('student');
        }
      }

      // Open submission modal
      function openSubmissionModal(homeworkId) {
        homeworkModalOpen = true;
        currentHomeworkId = homeworkId;
        tabBlurCount = 0;
        elements.submissionModal.classList.remove('hidden');
        elements.submissionContent.value = '';
        document.getElementById('submissionCounter').textContent = '0';
      }

      // Close submission modal
      function closeSubmissionModal() {
        homeworkModalOpen = false;
        currentHomeworkId = null;
        elements.submissionModal.classList.add('hidden');
      }

      // Show loading state
      function setLoading(button, isLoading) {
        const loading = button.querySelector('.loading');
        loading.classList.toggle('hidden', !isLoading);
        button.disabled = isLoading;
      }

      // Check authentication state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("User signed in:", user.email);
          elements.authSection.classList.add("hidden");
          
          // Get user data from Firestore
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              
              // Update user info displays
              elements.teacherEmail.textContent = user.email;
              elements.studentEmail.textContent = user.email;
              elements.teacherName.textContent = userData.fullName || 'Teacher';
              elements.studentName.textContent = userData.fullName || 'Student';
              elements.teacherAvatar.textContent = userData.fullName ? userData.fullName.charAt(0).toUpperCase() : 'T';
              elements.studentAvatar.textContent = userData.fullName ? userData.fullName.charAt(0).toUpperCase() : 'S';
              
              // Determine user type and show appropriate dashboard
              if (userData.userType === 'teacher') {
                elements.teacherSection.classList.remove("hidden");
                loadMessages("teacher");
                loadHomework('teacher');
              } else {
                elements.learnerSection.classList.remove("hidden");
                loadMessages("learner");
                loadHomework('student');
              }
            }
          } catch (error) {
            console.error("Error fetching user data:", error);
          }
        } else {
          console.log("User signed out");
          elements.teacherSection.classList.add("hidden");
          elements.learnerSection.classList.add("hidden");
          elements.authSection.classList.remove("hidden");
        }
      });

      // Login handler
      document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        
        elements.loginError.textContent = "";
        setLoading(elements.loginSubmitBtn, true);
        
        try {
          console.log("Attempting login with:", email);
          await signInWithEmailAndPassword(auth, email, password);
          console.log("Login successful");
        } catch (error) {
          console.error("Login error:", error);
          let errorMessage = "Login failed: ";
          
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage += 'Invalid email address';
              break;
            case 'auth/user-disabled':
              errorMessage += 'This account has been disabled';
              break;
            case 'auth/user-not-found':
              errorMessage += 'No account found with this email. Please register first.';
              break;
            case 'auth/wrong-password':
              errorMessage += 'Incorrect password';
              break;
            case 'auth/network-request-failed':
              errorMessage += 'Network error. Please check your connection';
              break;
            case 'auth/too-many-requests':
              errorMessage += 'Too many failed attempts. Please try again later.';
              break;
            default:
              errorMessage += error.message;
          }
          
          elements.loginError.textContent = errorMessage;
        } finally {
          setLoading(elements.loginSubmitBtn, false);
        }
      });

      // Registration handler
      document.getElementById("registerForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const fullName = document.getElementById("fullName").value.trim();
        const userType = document.getElementById("userType").value;
        
        elements.registerError.textContent = "";
        elements.registerSuccess.textContent = "";
        setLoading(elements.registerSubmitBtn, true);
        
        if (password.length < 8) {
          elements.registerError.textContent = "Password must be at least 8 characters long";
          setLoading(elements.registerSubmitBtn, false);
          return;
        }
        
        if (!fullName) {
          elements.registerError.textContent = "Please enter your full name";
          setLoading(elements.registerSubmitBtn, false);
          return;
        }
        
        if (!userType) {
          elements.registerError.textContent = "Please select your role";
          setLoading(elements.registerSubmitBtn, false);
          return;
        }

        try {
          console.log("Creating account for:", email);
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          console.log("Registration successful");
          
          // Store additional user data in Firestore
          try {
            await setDoc(doc(db, "users", userCredential.user.uid), {
              email: email,
              fullName: fullName,
              userType: userType,
              createdAt: serverTimestamp()
            });
          } catch (firestoreError) {
            console.error("Error saving user data:", firestoreError);
          }
          
          elements.registerSuccess.textContent = `Account created successfully! Welcome, ${fullName}.`;
          document.getElementById("registerForm").reset();
          
        } catch (error) {
          console.error("Registration error:", error);
          let errorMessage = "Registration failed: ";
          
          switch (error.code) {
            case 'auth/email-already-in-use':
              errorMessage += 'This email is already registered. Please login instead.';
              break;
            case 'auth/invalid-email':
              errorMessage += 'Invalid email address';
              break;
            case 'auth/weak-password':
              errorMessage += 'Password is too weak';
              break;
            case 'auth/operation-not-allowed':
              errorMessage += 'Email/password accounts are not enabled. Please check Firebase Console.';
              break;
            default:
              errorMessage += error.message;
          }
          
          elements.registerError.textContent = errorMessage;
        } finally {
          setLoading(elements.registerSubmitBtn, false);
        }
      });

      // Logout function
      window.logout = () => {
        signOut(auth).then(() => {
          console.log("User signed out");
          // Clear forms
          document.getElementById('loginForm').reset();
          document.getElementById('registerForm').reset();
          homeworkModalOpen = false;
          tabBlurCount = 0;
        }).catch((error) => {
          console.error("Logout error:", error);
        });
      };

      // Teacher post announcement
      document.getElementById("postBtn").addEventListener("click", async () => {
        const text = elements.announcement.value.trim();
        if (!text) {
          alert("Please enter an announcement before posting.");
          return;
        }
        
        if (text.length > 1000) {
          alert("Announcement is too long. Maximum 1000 characters allowed.");
          return;
        }
        
        try {
          await addDoc(collection(db, "announcements"), { 
            text, 
            date: serverTimestamp(),
            author: auth.currentUser.email,
            authorName: elements.teacherName.textContent
          });
          elements.announcement.value = "";
          document.getElementById('announcementCounter').textContent = '0';
          loadMessages("teacher");
        } catch (error) {
          console.error("Error posting announcement:", error);
          alert("Error posting announcement: " + error.message);
        }
      });

      // Teacher post homework
      document.getElementById("postHomeworkBtn").addEventListener("click", async () => {
        const title = elements.homeworkTitle.value.trim();
        const description = elements.homeworkDescription.value.trim();
        const dueDate = elements.homeworkDueDate.value;
        
        if (!title || !description || !dueDate) {
          alert("Please fill in all homework fields.");
          return;
        }
        
        if (title.length > 100) {
          alert("Homework title is too long. Maximum 100 characters allowed.");
          return;
        }
        
        if (description.length > 2000) {
          alert("Homework description is too long. Maximum 2000 characters allowed.");
          return;
        }
        
        try {
          await addDoc(collection(db, "homework"), { 
            title,
            description,
            dueDate: new Date(dueDate),
            date: serverTimestamp(),
            author: auth.currentUser.email,
            authorName: elements.teacherName.textContent
          });
          elements.homeworkTitle.value = "";
          elements.homeworkDescription.value = "";
          elements.homeworkDueDate.value = "";
          document.getElementById('homeworkCounter').textContent = '0';
          loadHomework('teacher');
        } catch (error) {
          console.error("Error posting homework:", error);
          alert("Error posting homework: " + error.message);
        }
      });

      // Student submit homework
      elements.submitHomeworkBtn.addEventListener("click", async () => {
        const content = elements.submissionContent.value.trim();
        if (!content) {
          alert("Please write your submission before submitting.");
          return;
        }
        
        if (content.length > 5000) {
          alert("Submission is too long. Maximum 5000 characters allowed.");
          return;
        }
        
        try {
          // Get student name
          const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
          const studentName = userDoc.exists() ? userDoc.data().fullName : 'Unknown Student';
          
          await addDoc(collection(db, "submissions"), { 
            homeworkId: currentHomeworkId,
            content,
            studentId: auth.currentUser.uid,
            studentEmail: auth.currentUser.email,
            studentName: studentName,
            date: serverTimestamp(),
            graded: false,
            grade: null
          });
          closeSubmissionModal();
          loadHomework('student');
          alert("Homework submitted successfully!");
        } catch (error) {
          console.error("Error submitting homework:", error);
          alert("Error submitting homework: " + error.message);
        }
      });

      // Load announcements
      async function loadMessages(role) {
        try {
          const q = query(collection(db, "announcements"), orderBy("date", "desc"));
          const querySnapshot = await getDocs(q);
          const container = role === "teacher" ? elements.teacherMessages : elements.learnerMessages;
          container.innerHTML = "";
          
          if (querySnapshot.empty) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üì¢</div>
                <h3>No Announcements Yet</h3>
                <p>${role === "teacher" ? "Post your first announcement to get started." : "Check back later for announcements from your teachers."}</p>
              </div>
            `;
            return;
          }
          
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "announcement-card";
            
            let dateString = "Recently";
            if (data.date) {
              try {
                dateString = data.date.toDate().toLocaleString();
              } catch (e) {
                dateString = new Date().toLocaleString();
              }
            }
            
            div.innerHTML = `
              <div>${data.text}</div>
              <div class="announcement-meta">
                <span class="announcement-author">By: ${data.authorName || data.author}</span>
                <span class="announcement-date">${dateString}</span>
              </div>
            `;
            container.appendChild(div);
          });
        } catch (error) {
          console.error("Error loading messages:", error);
          const container = role === "teacher" ? elements.teacherMessages : elements.learnerMessages;
          container.innerHTML = "<div class='error'>Error loading announcements. Please try again.</div>";
        }
      }

      // Load homework
      async function loadHomework(role) {
        try {
          const q = query(collection(db, "homework"), orderBy("date", "desc"));
          const querySnapshot = await getDocs(q);
          const container = role === "teacher" ? elements.teacherHomework : elements.studentHomework;
          container.innerHTML = "";
          
          if (querySnapshot.empty) {
            container.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üìö</div>
                <h3>No Homework Yet</h3>
                <p>${role === "teacher" ? "Assign your first homework to get started." : "Check back later for homework assignments."}</p>
              </div>
            `;
            return;
          }
          
          const homeworkPromises = [];
          
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "homework-card";
            
            let dateString = "Recently";
            let dueDateString = "Not set";
            
            if (data.date) {
              try {
                dateString = data.date.toDate().toLocaleString();
              } catch (e) {
                dateString = new Date().toLocaleString();
              }
            }
            
            if (data.dueDate) {
              try {
                dueDateString = data.dueDate.toDate().toLocaleString();
              } catch (e) {
                dueDateString = "Invalid date";
              }
            }
            
            if (role === "teacher") {
              div.innerHTML = `
                <h4>${data.title}</h4>
                <div style="white-space: pre-wrap;">${data.description}</div>
                <div class="teacher-name">Assigned by: ${data.authorName || data.author}</div>
                <div class="homework-meta">
                  <span>Due: ${dueDateString}</span>
                  <span>Assigned: ${dateString}</span>
                </div>
              `;
            } else {
              const promise = checkSubmissionStatus(doc.id, auth.currentUser.uid).then(hasSubmitted => {
                const buttonText = hasSubmitted ? "Submitted ‚úì" : "Submit Homework";
                const buttonClass = hasSubmitted ? "secondary" : "success";
                const buttonDisabled = hasSubmitted ? "disabled" : "";
                
                div.innerHTML = `
                  <h4>${data.title}</h4>
                  <div style="white-space: pre-wrap;">${data.description}</div>
                  <div class="teacher-name">Assigned by: ${data.authorName || data.author}</div>
                  <div class="homework-meta">
                    <span>Due: ${dueDateString}</span>
                    <span>Assigned: ${dateString}</span>
                  </div>
                  <button class="${buttonClass}" ${buttonDisabled} onclick="openSubmissionModal('${doc.id}')" style="margin-top: 10px; width: auto;">${buttonText}</button>
                `;
              });
              homeworkPromises.push(promise);
            }
            
            container.appendChild(div);
          });
          
          // Wait for all submission status checks to complete
          await Promise.all(homeworkPromises);
        } catch (error) {
          console.error("Error loading homework:", error);
          const container = role === "teacher" ? elements.teacherHomework : elements.studentHomework;
          container.innerHTML = "<div class='error'>Error loading homework. Please try again.</div>";
        }
      }

      // Check if student has submitted homework
      async function checkSubmissionStatus(homeworkId, studentId) {
        try {
          const q = query(
            collection(db, "submissions"), 
            where("homeworkId", "==", homeworkId),
            where("studentId", "==", studentId)
          );
          const querySnapshot = await getDocs(q);
          return !querySnapshot.empty;
        } catch (error) {
          console.error("Error checking submission status:", error);
          return false;
        }
      }

      // Load submissions for teacher
      async function loadSubmissions() {
        try {
          const q = query(collection(db, "submissions"), orderBy("date", "desc"));
          const querySnapshot = await getDocs(q);
          elements.teacherSubmissions.innerHTML = "";
          
          if (querySnapshot.empty) {
            elements.teacherSubmissions.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <h3>No Submissions Yet</h3>
                <p>Student submissions will appear here.</p>
              </div>
            `;
            return;
          }
          
          const submissionPromises = [];
          
          querySnapshot.forEach(async (doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "submission-card";
            
            let dateString = "Recently";
            if (data.date) {
              try {
                dateString = data.date.toDate().toLocaleString();
              } catch (e) {
                dateString = new Date().toLocaleString();
              }
            }
            
            // Get homework title
            const promise = (async () => {
              let homeworkTitle = "Unknown Homework";
              try {
                const homeworkDoc = await getDoc(doc(db, "homework", data.homeworkId));
                if (homeworkDoc.exists()) {
                  homeworkTitle = homeworkDoc.data().title;
                }
              } catch (error) {
                console.error("Error fetching homework title:", error);
              }
              
              const gradeValue = data.grade || "";
              const gradeInput = data.graded ? 
                `<input type="text" class="grade-input" value="${gradeValue}" disabled>` :
                `<input type="text" class="grade-input" id="grade-${doc.id}" placeholder="Grade" maxlength="10">`;
              
              const gradeButton = data.graded ? 
                `<button class="secondary" disabled>Graded</button>` :
                `<button class="success" onclick="gradeSubmission('${doc.id}')">Grade</button>`;
              
              div.innerHTML = `
                <h4>${homeworkTitle}</h4>
                <div><strong>Student:</strong> ${data.studentName || data.studentEmail}</div>
                <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap;">${data.content}</div>
                <div class="homework-meta">
                  <span>Submitted: ${dateString}</span>
                  <div>
                    ${gradeInput}
                    ${gradeButton}
                  </div>
                </div>
              `;
            })();
            
            submissionPromises.push(promise);
            elements.teacherSubmissions.appendChild(div);
          });
          
          await Promise.all(submissionPromises);
        } catch (error) {
          console.error("Error loading submissions:", error);
          elements.teacherSubmissions.innerHTML = "<div class='error'>Error loading submissions. Please try again.</div>";
        }
      }

      // Load student list for teacher
      async function loadStudentList() {
        try {
          const q = query(collection(db, "users"), where("userType", "==", "learner"));
          const querySnapshot = await getDocs(q);
          elements.studentList.innerHTML = "";
          
          if (querySnapshot.empty) {
            elements.studentList.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üë®‚Äçüéì</div>
                <h3>No Students Registered</h3>
                <p>Student registrations will appear here.</p>
              </div>
            `;
            return;
          }
          
          // Get all homework assignments
          const homeworkQuery = query(collection(db, "homework"));
          const homeworkSnapshot = await getDocs(homeworkQuery);
          const homeworkIds = homeworkSnapshot.docs.map(doc => doc.id);
          
          // Check submission status for each student
          const studentPromises = [];
          
          querySnapshot.forEach((doc) => {
            const studentData = doc.data();
            const studentItem = document.createElement("div");
            studentItem.className = "student-item";
            
            const promise = (async () => {
              let submissionStatus = "No homework assigned";
              
              if (homeworkIds.length > 0) {
                // Check if student has submitted all homework
                const submissionChecks = await Promise.all(
                  homeworkIds.map(hwId => checkSubmissionStatus(hwId, doc.id))
                );
                
                const submittedCount = submissionChecks.filter(status => status).length;
                const totalCount = homeworkIds.length;
                
                if (submittedCount === totalCount) {
                  submissionStatus = `<span class="student-status status-submitted">All Submitted (${submittedCount}/${totalCount})</span>`;
                } else {
                  submissionStatus = `<span class="student-status status-pending">Pending (${submittedCount}/${totalCount})</span>`;
                }
              }
              
              studentItem.innerHTML = `
                <div>
                  <strong>${studentData.fullName}</strong>
                  <div style="font-size: 0.8rem; color: var(--secondary-color);">${studentData.email}</div>
                </div>
                <div>${submissionStatus}</div>
              `;
            })();
            
            studentPromises.push(promise);
            elements.studentList.appendChild(studentItem);
          });
          
          await Promise.all(studentPromises);
        } catch (error) {
          console.error("Error loading student list:", error);
          elements.studentList.innerHTML = "<div class='error'>Error loading student list. Please try again.</div>";
        }
      }

      // Grade submission
      window.gradeSubmission = async (submissionId) => {
        const gradeInput = document.getElementById(`grade-${submissionId}`);
        const grade = gradeInput.value.trim();
        
        if (!grade) {
          alert("Please enter a grade.");
          return;
        }
        
        if (grade.length > 10) {
          alert("Grade is too long. Maximum 10 characters allowed.");
          return;
        }
        
        try {
          await updateDoc(doc(db, "submissions", submissionId), {
            graded: true,
            grade: grade
          });
          loadSubmissions();
        } catch (error) {
          console.error("Error grading submission:", error);
          alert("Error grading submission: " + error.message);
        }
      };

      // Event listeners for tab buttons
      elements.loginTabBtn.addEventListener('click', () => showAuthTab('login'));
      elements.registerTabBtn.addEventListener('click', () => showAuthTab('register'));
      
      document.querySelectorAll('.content-tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.getAttribute('data-tab');
          if (elements.teacherSection.classList.contains('hidden')) {
            showStudentTab(tabName);
          } else {
            showTeacherTab(tabName);
          }
        });
      });

      // Initialize character counters
      initializeCharacterCounters();

      // Make functions available globally
      window.showTab = showAuthTab;
      window.showTeacherTab = showTeacherTab;
      window.showStudentTab = showStudentTab;
      window.openSubmissionModal = openSubmissionModal;
      window.closeSubmissionModal = closeSubmissionModal;
      window.gradeSubmission = window.gradeSubmission;

    } catch (error) {
      console.error("Application initialization error:", error);
      alert("Application initialization failed. Please check your connection and try again.");
    }
  </script>
</body>
</html>
